name: docker

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from package.json
        id: pkg
        run: echo "version=$(cat package.json | jq -r .version)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/stripez:latest
            ghcr.io/${{ github.repository_owner }}/stripez:${{ steps.pkg.outputs.version }}

      - name: Generate AI-powered release notes
        id: ai_notes
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          VERSION="${{ steps.pkg.outputs.version }}"
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "AI release notes skipped: GEMINI_API_KEY not set."
            {
              echo "notes=Release $VERSION built. Set GEMINI_API_KEY to enable AI-generated notes."
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          COMMITS=$(git log -10 --pretty=format:'- %s (%an)')
          PROMPT=$'Generate a changelog for Stripez / Schikko Rules app version '"${{ steps.pkg.outputs.version }}"$' following Keep a Changelog format (https://keepachangelog.com/en/1.1.0/). Use this structure:\n\n## [${{ steps.pkg.outputs.version }}] - 2025-XX-XX\n\n### Added\n- (list new features)\n\n### Changed\n- (list changes to existing functionality)\n\n### Fixed\n- (list bug fixes)\n\n### Removed\n- (list removed features)\n\nBased on these commits, populate the relevant sections. Use proper markdown formatting with ### headers and - bullet points. Reference specific commits where relevant. If a section has no changes, omit it. Focus on technical changes only.\n\nCommits:\n'
          
          # Create JSON payload and save to temp file
          JSON_FILE=$(mktemp)
          jq -n --arg prompt "$PROMPT" --arg commits "$COMMITS" '{
            contents: [
              {
                parts: [
                  {
                    text: ($prompt + "\n" + $commits)
                  }
                ]
              }
            ]
          }' > "$JSON_FILE"
          
          # Make API call with better error handling
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @"$JSON_FILE")
          
          # Clean up temp file
          rm -f "$JSON_FILE"
          
          # Extract body and status
          BODY=$(echo "$RESPONSE" | sed -e 's/HTTPSTATUS:.*//g')
          HTTP_STATUS=$(echo "$RESPONSE" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          
          # Debug info
          echo "HTTP Status: $HTTP_STATUS"
          echo "Response length: $(echo "$BODY" | wc -c)"
          
          # Extract text from Gemini response
          if [ "$HTTP_STATUS" = "200" ]; then
            BODY=$(echo "$BODY" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null || echo "")
          else
            echo "Gemini API error: HTTP $HTTP_STATUS"
            echo "Response: $BODY"
            BODY=""
          fi

          if [ -z "$BODY" ] || [ "$BODY" = "null" ]; then
            BODY="Release $VERSION for Stripez / Schikko Rules.\n- Internal changes deployed.\n- AI description unavailable (API error).\n\nMay your ledgers be accurate and your stripes well-deserved."
          fi

          # Properly escape for GitHub Actions - use heredoc to handle multiline content
          {
            echo 'notes<<EOF'
            echo "$BODY"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.pkg.outputs.version }}
          name: Stripez v${{ steps.pkg.outputs.version }}
          body: ${{ steps.ai_notes.outputs.notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}