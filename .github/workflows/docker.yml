name: docker

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from package.json
        id: pkg
        run: echo "version=$(cat package.json | jq -r .version)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/stripez:latest
            ghcr.io/${{ github.repository_owner }}/stripez:${{ steps.pkg.outputs.version }}

      - name: Generate AI-powered release notes
        id: ai_notes
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          VERSION="${{ steps.pkg.outputs.version }}"
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "AI release notes skipped: GEMINI_API_KEY not set."
            {
              echo "notes=Release $VERSION built. Set GEMINI_API_KEY to enable AI-generated notes."
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          COMMITS=$(git log -10 --pretty=format:'- %s (%an)')
          PROMPT=$'You are a witty but clear scribe for the "Stripez / Schikko Rules" app.\nSummarize the following commits into:\n1) A short ceremonial headline (max 80 chars).\n2) 3-7 bullet points of notable changes, grouped logically.\n3) A short closing blessing or toast (1 sentence).\nKeep it crisp, helpful, and fun, but not cringe. No markdown headings, only plain text and bullets.\nCommits:\n'
          BODY=$(jq -n --arg prompt "$PROMPT" --arg commits "$COMMITS" '
            {
              contents: [
                {
                  parts: [
                    {
                      text: ($prompt + "\n" + $commits)
                    }
                  ]
                }
              ]
            }
          ' | curl -sS "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=$GEMINI_API_KEY" \
               -H "Content-Type: application/json" \
               -d @- | jq -r ".candidates[0].content.parts[0].text" || true)

          if [ -z "$BODY" ] || [ "$BODY" = "null" ]; then
            BODY="Release $VERSION for Stripez / Schikko Rules.\n- Internal changes deployed.\n- AI description unavailable (API error).\n\nMay your ledgers be accurate and your stripes well-deserved."
          fi

          BODY_ESCAPED="${BODY//'%'/'%25'}"
          BODY_ESCAPED="${BODY_ESCAPED//$'\n'/'%0A'}"
          BODY_ESCAPED="${BODY_ESCAPED//$'\r'/'%0D'}"

          echo "notes=$BODY_ESCAPED" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.pkg.outputs.version }}
          name: Stripez v${{ steps.pkg.outputs.version }}
          body: ${{ steps.ai_notes.outputs.notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}